#!/bin/bash

# Pre-commit hook pour CharleBin
# - Fixe automatiquement les erreurs de style avec PHP CS Fixer
# - Ajoute les fichiers corrig√©s au staging area
# - Bloque le commit si PHPMD d√©tecte des erreurs critiques

echo "üîç Pre-commit hook activ√©..."

# R√©cup√©rer la liste des fichiers PHP modifi√©s et en staging
PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')

if [ -z "$PHP_FILES" ]; then
    echo "‚úÖ Aucun fichier PHP √† v√©rifier"
    exit 0
fi

echo "üìù Fichiers PHP d√©tect√©s :"
echo "$PHP_FILES"

# ============================================
# 1. PHP CS Fixer - Correction automatique
# ============================================
echo ""
echo "üîß Ex√©cution de PHP CS Fixer..."

# V√©rifier si PHP CS Fixer est install√©
if [ ! -f "./vendor/bin/php-cs-fixer" ]; then
    echo "‚ö†Ô∏è  PHP CS Fixer non trouv√©. Installation..."
    composer require --dev friendsofphp/php-cs-fixer
fi

# Appliquer PHP CS Fixer sur chaque fichier
HAS_FIXES=0
for FILE in $PHP_FILES; do
    if [ -f "$FILE" ]; then
        echo "  ‚Üí Traitement de $FILE"
        ./vendor/bin/php-cs-fixer fix "$FILE" --rules=@PSR12 --quiet
        
        # V√©rifier si le fichier a √©t√© modifi√©
        if ! git diff --quiet "$FILE"; then
            echo "    ‚úì Corrections appliqu√©es sur $FILE"
            # Ajouter les modifications au staging area
            git add "$FILE"
            HAS_FIXES=1
        fi
    fi
done

if [ $HAS_FIXES -eq 1 ]; then
    echo "‚úÖ Fichiers corrig√©s et ajout√©s au commit"
else
    echo "‚úÖ Aucune correction n√©cessaire"
fi

# ============================================
# 2. PHPMD - V√©rification stricte
# ============================================
echo ""
echo "üîç Ex√©cution de PHPMD (PHP Mess Detector)..."

PHPMD_ERRORS=0

for FILE in $PHP_FILES; do
    if [ -f "$FILE" ]; then
        # Exclure les fichiers de vendor et de test
        if [[ ! "$FILE" =~ ^vendor/ ]] && [[ ! "$FILE" =~ ^tst/ ]]; then
            echo "  ‚Üí Analyse de $FILE"
            
            # Ex√©cuter PHPMD avec des r√®gles strictes
            ./vendor/bin/phpmd "$FILE" text codesize,unusedcode,naming,design,controversial --suffixes php 2>&1
            
            if [ $? -ne 0 ]; then
                PHPMD_ERRORS=1
            fi
        fi
    fi
done

# ============================================
# 3. D√©cision finale
# ============================================
echo ""
if [ $PHPMD_ERRORS -eq 1 ]; then
    echo "‚ùå COMMIT BLOQU√â : Des probl√®mes de qualit√© de code ont √©t√© d√©tect√©s par PHPMD"
    echo ""
    echo "üí° Conseils :"
    echo "   - Corrigez les erreurs signal√©es par PHPMD"
    echo "   - Ou utilisez 'git commit --no-verify' pour forcer le commit (d√©conseill√©)"
    exit 1
else
    echo "‚úÖ Toutes les v√©rifications sont pass√©es"
    echo "‚úÖ Commit autoris√©"
    exit 0
fi
